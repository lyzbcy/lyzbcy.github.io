# 日历功能实现文档

## 功能概述

这是一个基于 Jekyll 的日历组件，支持从博客文章和手动数据源中提取事件，并在日历视图中展示。主要特性包括：

- 📅 月视图日历展示
- 🔄 支持从博客 front matter 自动提取提醒日期
- 📝 支持手动添加事件（通过 YAML 数据文件）
- 🎨 事件类型分类（作业、考试、活动）并带有不同颜色标识
- 🔗 事件可链接到对应的博客文章
- 📱 响应式设计，支持移动端
- 🎯 点击日期查看详情模态框
- ⚡ 实时事件统计

## 技术架构

### 技术栈
- **后端处理**: Jekyll (Ruby) + Liquid 模板
- **前端渲染**: 原生 JavaScript (ES6+)
- **样式**: CSS3 (响应式设计)
- **数据格式**: YAML + JSON

### 数据流程

```
博客文章 (front matter)
    ↓
Jekyll 插件提取 reminder_date
    ↓
生成 calendar_from_posts 数据
    ↓
合并 calendar.yml 数据
    ↓
Liquid 模板生成 JSON
    ↓
JavaScript 渲染日历
```

## 文件结构

```
项目根目录/
├── _plugins/
│   └── calendar-from-posts.rb    # Jekyll 插件：从博客提取提醒日期
├── _data/
│   └── calendar.yml               # 手动添加的事件数据
├── _tabs/
│   └── calendar.md                # 日历页面（包含 HTML/CSS/JS 引用）
└── assets/js/
    └── calendar.js                # 日历渲染和交互逻辑
```

## 数据源

### 1. 博客文章 Front Matter

在博客文章的 front matter 中添加以下字段：

```yaml
---
title: "作业标题"
date: 2025-11-03
categories: [通知]
tags: [作业]
reminder_date: 2025-12-21    # 提醒日期（格式：YYYY-MM-DD）
reminder_type: homework       # 事件类型（可选：homework、test、activity，默认为 homework）
---
```

**字段说明：**
- `reminder_date`（必需）：提醒日期，格式为 `YYYY-MM-DD`
- `reminder_type`（可选）：事件类型
  - `homework`：作业（默认，红色显示）
  - `test`：考试（橙色显示）
  - `activity`：活动（绿色显示）

### 2. 手动事件数据 (_data/calendar.yml)

```yaml
- date: 2025-10-17
  event: "班会"
  type: "activity"

- date: 2025-10-19
  event: "互动媒体技术展厅布置"
  type: "homework"
```

**字段说明：**
- `date`（必需）：事件日期，格式为 `YYYY-MM-DD`
- `event`（必需）：事件标题
- `type`（可选）：事件类型，同博客 front matter 的 `reminder_type`
- `link`（可选）：事件链接 URL
- `linkTarget`（可选）：链接打开方式，默认为 `_self`

## 核心实现

### 1. Jekyll 插件 (_plugins/calendar-from-posts.rb)

**功能：** 扫描所有博客文章，提取包含 `reminder_date` 的文章，生成日历事件数据。

**关键代码：**

```ruby
module Jekyll
  class CalendarFromPostsGenerator < Generator
    safe true
    priority :low

    def generate(site)
      post_events = []
      
      site.posts.docs.each do |post|
        reminder_date = post.data['reminder_date']
        
        if reminder_date
          begin
            date_obj = Date.parse(reminder_date.to_s)
            formatted_date = date_obj.strftime('%Y-%m-%d')
            
            event_data = {
              'date' => formatted_date,
              'event' => post.data['title'] || post.data['name'] || '未命名事件',
              'type' => post.data['reminder_type'] || 'homework',
              'link' => post.url ? "#{site.baseurl}#{post.url}" : nil,
              'linkTarget' => '_self'
            }
            
            post_events << event_data
          rescue ArgumentError => e
            Jekyll.logger.warn "CalendarFromPosts:", "无法解析提醒日期: #{reminder_date}"
          end
        end
      end
      
      site.data['calendar_from_posts'] = post_events
    end
  end
end
```

**输出数据格式：**

```json
[
  {
    "date": "2025-12-21",
    "event": "习思想--大作业",
    "type": "homework",
    "link": "/2025/11/03/习思想--大作业/",
    "linkTarget": "_self"
  }
]
```

### 2. 数据合并 (Liquid 模板)

在日历页面中，使用 Liquid 模板合并两个数据源：

```liquid
{%- assign manual_events = site.data.calendar -%}
{%- assign post_events = site.data.calendar_from_posts -%}
{%- if manual_events and post_events -%}
  {%- assign all_events = manual_events | concat: post_events -%}
  {{ all_events | jsonify }}
{%- elsif manual_events -%}
  {{ manual_events | jsonify }}
{%- elsif post_events -%}
  {{ post_events | jsonify }}
{%- else -%}
  []
{%- endif -%}
```

### 3. 日历渲染 (assets/js/calendar.js)

**核心功能：**

1. **日历渲染** (`renderCalendar()`)
   - 计算月份的第一天和最后一天
   - 生成日历表格
   - 标记今天和过去的日期
   - 显示事件标签

2. **事件显示**
   - 每个日期单元格最多显示 2 个事件（移动端 1 个）
   - 超出部分显示 "+N" 提示
   - 事件标签根据类型显示不同颜色

3. **交互功能**
   - 点击日期单元格：显示详情模态框
   - 点击事件标签：如果有链接则跳转，否则显示详情模态框
   - 月份切换：上/下月按钮
   - 回到今天：快速定位到当前月份

4. **详情模态框**
   - 显示该日期的所有事件
   - 支持事件链接跳转
   - 点击背景或 ESC 键关闭

**关键代码片段：**

```javascript
// 渲染日历
function renderCalendar() {
  const firstDay = new Date(year, month - 1, 1).getDay();
  const lastDay = new Date(year, month, 0).getDate();
  // ... 生成表格单元格
  
  // 为每个日期添加事件
  const events = calendarData.filter(e => e.date === dateStr);
  if (events.length) {
    // 显示事件标签
    // 添加点击事件处理
  }
}

// 显示详情模态框
function showEventModal(dateStr, events) {
  // 格式化日期显示
  // 渲染事件列表
  // 处理事件链接
}
```

### 4. 样式设计 (_tabs/calendar.md)

**设计特点：**

1. **响应式布局**
   - 桌面端：完整日历视图
   - 平板端：优化间距和字体
   - 移动端：紧凑布局，减少显示事件数量

2. **视觉设计**
   - 今天日期：深色背景，白色文字
   - 过去日期：半透明显示
   - 事件类型颜色：
     - 作业 (homework): `#ff6b6b` (红色)
     - 考试 (test): `#ffa726` (橙色)
     - 活动 (activity): `#66bb6a` (绿色)

3. **交互反馈**
   - 悬停效果
   - 点击动画
   - 模态框淡入/滑入动画

**关键 CSS：**

```css
/* 事件类型颜色 */
.event.homework { 
  background-color: #ff6b6b;
  color: #fff; 
}

.event.test { 
  background-color: #ffa726;
  color: #fff; 
}

.event.activity { 
  background-color: #66bb6a;
  color: #fff; 
}

/* 今天日期样式 */
.calendar-container table td.today { 
  background-color: #1a1a1a !important; 
  color: #fff;
}

/* 响应式设计 */
@media (max-width: 768px) {
  /* 移动端样式 */
}
```

## HTML 结构

```html
<div class="calendar-container">
  <!-- 头部导航 -->
  <div class="calendar-header">
    <div class="nav-buttons">
      <button id="prevMonth">‹ 上月</button>
      <button id="todayBtn">今天</button>
      <button id="nextMonth">下月 ›</button>
    </div>
    <h3 id="monthTitle">2025年10月</h3>
  </div>
  
  <!-- 事件统计 -->
  <div id="eventStats" class="event-stats"></div>
  
  <!-- 日历表格 -->
  <table class="calendar">
    <thead>
      <tr><th>日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th></tr>
    </thead>
    <tbody id="calendarBody"></tbody>
  </table>
</div>

<!-- 详情模态框 -->
<div id="eventModal" class="event-modal">
  <div class="event-modal-content">
    <div class="event-modal-header">
      <h3 id="modalDateTitle">日期详情</h3>
      <button class="event-modal-close" id="modalCloseBtn">&times;</button>
    </div>
    <div class="event-modal-body">
      <div class="event-modal-date" id="modalDateText"></div>
      <div class="event-modal-events" id="modalEventsList"></div>
    </div>
  </div>
</div>

<!-- 数据 JSON -->
<script id="calendarData" type="application/json">
  <!-- Liquid 模板生成的 JSON 数据 -->
</script>

<!-- JavaScript -->
<script src="/assets/js/calendar.js"></script>
```

## 使用方法

### 1. 安装和配置

1. **创建 Jekyll 插件目录**（如果不存在）：
   ```
   mkdir _plugins
   ```

2. **复制插件文件**：
   - 将 `calendar-from-posts.rb` 放入 `_plugins/` 目录

3. **创建数据文件**：
   - 在 `_data/` 目录创建 `calendar.yml`（如果不存在）

4. **创建日历页面**：
   - 创建 `_tabs/calendar.md` 或类似页面
   - 复制 HTML/CSS 结构

5. **添加 JavaScript 文件**：
   - 将 `calendar.js` 放入 `assets/js/` 目录

### 2. 添加事件

**方式一：通过博客文章**

在博客文章的 front matter 中添加：

```yaml
---
title: "作业标题"
reminder_date: 2025-12-21
reminder_type: homework
---
```

**方式二：手动添加**

在 `_data/calendar.yml` 中添加：

```yaml
- date: 2025-10-17
  event: "班会"
  type: "activity"
```

### 3. 自定义样式

修改 `_tabs/calendar.md` 中的 CSS 部分，可以自定义：
- 颜色主题
- 字体大小
- 间距布局
- 响应式断点

## 功能特性详解

### 1. 事件类型系统

支持三种事件类型，每种类型有独特的视觉标识：

- **homework（作业）**：红色标签，用于作业、实验等学习任务
- **test（考试）**：橙色标签，用于考试、测验等评估活动
- **activity（活动）**：绿色标签，用于班级活动、会议等

### 2. 智能事件显示

- **桌面端**：每个日期单元格最多显示 2 个事件
- **移动端**：每个日期单元格最多显示 1 个事件
- **超出部分**：显示 "+N" 提示，点击可查看全部

### 3. 链接支持

- 从博客提取的事件自动链接到对应博客文章
- 手动添加的事件可设置 `link` 字段添加链接
- 点击事件标签直接跳转（新标签页或当前页）

### 4. 响应式设计

**断点设置：**
- `≤ 768px`：平板优化
- `≤ 480px`：手机优化
- `≤ 360px`：小屏手机优化

**适配内容：**
- 按钮大小和间距
- 字体大小
- 日历单元格高度
- 事件标签数量
- 模态框尺寸

### 5. 交互体验

- **日期单元格**：点击显示该日期的所有事件
- **事件标签**：点击跳转或显示详情
- **模态框**：
  - 点击背景关闭
  - 点击关闭按钮关闭
  - ESC 键关闭
  - 点击内容区域不关闭（防止误操作）

## 数据格式规范

### 事件对象结构

```typescript
interface CalendarEvent {
  date: string;           // 日期，格式：YYYY-MM-DD
  event: string;          // 事件标题
  type?: string;         // 事件类型：homework | test | activity
  link?: string;         // 事件链接 URL（可选）
  linkTarget?: string;   // 链接打开方式：_self | _blank（可选）
}
```

### 日期格式要求

- **格式**：`YYYY-MM-DD`
- **示例**：`2025-12-21`
- **时区**：使用本地时区

## 扩展建议

### 1. 添加更多事件类型

在 CSS 中添加新的类型样式：

```css
.event.custom-type { 
  background-color: #your-color;
  color: #fff; 
}
```

在 JavaScript 中添加类型名称映射：

```javascript
const typeNames = {
  homework: "作业",
  test: "考试",
  activity: "活动",
  customType: "自定义类型"  // 新增
};
```

### 2. 支持重复事件

可以扩展插件支持：
- 每周重复
- 每月重复
- 自定义重复规则

### 3. 事件提醒功能

可以添加：
- 邮件提醒
- 浏览器通知
- 提前 N 天提醒

### 4. 事件搜索和筛选

可以添加：
- 按类型筛选
- 按日期范围筛选
- 关键词搜索

## 注意事项

1. **Jekyll 插件限制**
   - 某些 Jekyll 托管平台（如 GitHub Pages）可能不支持自定义插件
   - 需要本地构建或使用支持插件的构建服务

2. **日期解析**
   - 确保日期格式正确（YYYY-MM-DD）
   - 无效日期会被忽略并记录警告

3. **性能考虑**
   - 大量事件可能影响渲染性能
   - 建议限制单日事件数量或使用虚拟滚动

4. **浏览器兼容性**
   - 需要支持 ES6+ 的现代浏览器
   - 移动端需要支持触摸事件

## 故障排查

### 问题：事件不显示

1. 检查 Jekyll 插件是否正常加载
2. 检查 `reminder_date` 格式是否正确
3. 检查浏览器控制台是否有 JavaScript 错误
4. 检查 JSON 数据是否正确生成

### 问题：链接不工作

1. 检查 `link` 字段是否正确设置
2. 检查 URL 路径是否正确
3. 检查 `linkTarget` 设置

### 问题：样式显示异常

1. 检查 CSS 是否正确加载
2. 检查是否有样式冲突
3. 检查响应式断点设置

## 总结

这个日历功能实现了一个完整的、可扩展的事件管理系统，主要优势包括：

- ✅ **自动化**：从博客文章自动提取提醒日期
- ✅ **灵活性**：支持手动和自动两种数据源
- ✅ **用户友好**：直观的界面和流畅的交互
- ✅ **响应式**：完美适配各种设备
- ✅ **可扩展**：易于添加新功能和自定义样式

通过这个文档，开发者可以理解整个系统的架构和实现细节，并在其他项目中复用或改进这个功能。

